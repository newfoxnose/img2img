# 人脸检测功能说明

## 功能概述

本应用集成了基于 **face-api.js** 的自动人脸检测功能，可以自动检测照片中的人脸并智能设置证件照裁剪区域。

## 模型文件

### 本地模型（推荐）

为了支持离线使用和更快的加载速度，建议下载模型文件到本地：

1. **运行下载脚本**：
   ```bash
   npm run download-models
   ```

2. **模型文件位置**：
   - 模型文件保存在 `public/models/` 目录
   - 包含 4 个文件，总大小约 2-3MB

3. **模型文件列表**：
   - `tiny_face_detector_model-weights_manifest.json`
   - `tiny_face_detector_model-shard1`
   - `face_landmark_68_model-weights_manifest.json`
   - `face_landmark_68_model-shard1`

### 自动回退机制

系统会自动检测本地模型文件是否存在：

- ✅ **本地模型存在**：使用本地模型（更快，支持离线）
- ⚠️ **本地模型不存在**：自动从 CDN 加载（需要网络连接）

## 使用方法

1. **上传照片**：选择或拖拽照片到上传区域
2. **点击编辑**：点击照片列表中的"编辑"按钮
3. **自动检测**：点击"🤖 自动检测人脸"按钮
4. **等待检测**：系统会自动加载模型并检测人脸（首次使用需要下载模型）
5. **自动定位**：检测完成后，裁剪框会自动定位到合适的位置
6. **手动微调**：可以拖动裁剪框或调整四角来微调位置
7. **调整参数**：使用滑块调整亮度和对比度
8. **处理照片**：点击"批量处理"或单独处理照片

## 技术细节

### 人脸检测算法

- 使用 `tinyFaceDetector` 模型进行快速人脸检测
- 使用 `faceLandmark68Net` 模型获取人脸关键点
- 根据证件照标准比例自动计算裁剪区域

### 裁剪区域计算

- 人脸高度占裁剪区域高度的 35%（符合证件照标准）
- 人脸中心位于裁剪区域上方 40% 位置
- 自动适配 1寸（295×413px）和大2寸（413×626px）两种尺寸

## 注意事项

1. **首次使用**：
   - 如果本地模型不存在，首次使用需要从 CDN 下载模型（约 2-3MB）
   - 下载完成后，后续使用会更快

2. **网络要求**：
   - 如果本地模型文件不存在，需要网络连接从 CDN 加载
   - 建议运行 `npm run download-models` 下载本地模型

3. **检测失败**：
   - 如果照片中没有人脸或检测失败，会提示手动调整
   - 可以手动拖动裁剪框来设置位置

4. **隐私安全**：
   - 所有处理都在浏览器本地完成
   - 照片不会上传到服务器
   - 模型文件可以从本地加载，完全离线使用

## 故障排除

### 模型加载失败

如果遇到模型加载失败的问题：

1. **检查网络连接**：确保可以访问 CDN
2. **下载本地模型**：运行 `npm run download-models`
3. **检查文件路径**：确保 `public/models/` 目录存在且包含模型文件
4. **清除缓存**：刷新浏览器或清除缓存后重试

### 人脸检测失败

如果无法检测到人脸：

1. **检查照片质量**：确保照片清晰，人脸可见
2. **检查人脸大小**：人脸不能太小（建议至少占图片的 10%）
3. **检查光线条件**：确保人脸光线充足，没有严重阴影
4. **手动调整**：如果自动检测失败，可以手动拖动裁剪框

## 开发说明

### 模型文件管理

- 模型文件存储在 `public/models/` 目录
- 可以通过 `npm run download-models` 脚本下载
- 下载脚本：`scripts/download-models.js`

### 代码位置

- 人脸检测工具：`utils/faceDetection.ts`
- 编辑器组件：`components/IDPhotoEditor.tsx`
- 模型下载脚本：`scripts/download-models.js`

